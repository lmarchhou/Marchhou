<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.uih.uplus.solar.equipment.management.mapper.DeviceMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="resultMap" type="com.uih.uplus.solar.equipment.management.entity.Device">
        <id column="ID" property="id"/>
        <result column="SYSTEM_ID" property="systemId"/>
        <result column="MATERIAL_NUMBER" property="materialNumber"/>
        <result column="STATUS" property="status"/>
        <result column="CUSTOMER_ID" property="customerId"/>
        <result column="TYPE_ID" property="typeId"/>
        <result column="SHIPPING_DATETIME" property="shippingDatetime"/>
        <result column="SETUP_START_DATETIME" property="setupStartDatetime"/>
        <result column="SETUP_END_DATETIME" property="setupEndDatetime"/>
        <result column="ENGINEER_ID" property="engineerId"/>
        <result column="SALESMAN" property="salesman"/>
        <result column="SERIAL_NUMBER" property="serialNumber"/>
        <result column="WARRANTY_EFFECTIVE_DATETIME" property="warrantyEffectiveDatetime"/>
        <result column="WARRANTY_EXPIRATION_DATETIME" property="warrantyExpirationDatetime"/>
        <result column="ORDER_NUMBER" property="orderNumber"/>
        <result column="PROJECT_MANAGER" property="projectManager"/>
        <result column="INSTALLATION_ENGINEER" property="installationEngineer"/>
        <result column="ACCEPTANCE_CHECK_DATETIME" property="acceptanceCheckDatetime"/>
        <result column="SECOND_ENGINEER_ID" property="secondEngineerId"/>
        <result column="DONGLE_ID" property="dongleId"/>
        <result column="WEIXIN_RECEIVERS" property="weixinReceivers"/>
        <result column="SERVICE_KEY_L2" property="serviceKeyL2"/>
        <result column="L2_KEY_EXPIRATION_DATETIME" property="l2KeyExpirationDatetime"/>
        <result column="SERVICE_KEY_L3" property="serviceKeyL3"/>
        <result column="L3_KEY_EXPIRATION_DATETIME" property="l3KeyExpirationDatetime"/>
        <result column="SERVICE_KEY_L1" property="serviceKeyL1"/>
        <result column="DELETED" property="deleted"/>
        <result column="CREATE_USER_ID" property="createUserId"/>
        <result column="CREATE_DATETIME" property="createDatetime"/>
        <result column="MODIFY_USER_ID" property="modifyUserId"/>
        <result column="MODIFY_DATETIME" property="modifyDatetime"/>
        <result column="SF_ID" property="sfId"/>
        <result column="MANUFACTURER_ID" property="manufacturerId"/>
        <result column="VERSION" property="version"/>
    </resultMap>
    <resultMap id="resultMapForPageList" type="com.uih.uplus.solar.equipment.management.model.view.DeviceModel">
        <result column="ID" property="id"/>
        <result column="SYSTEM_ID" property="systemId"/>
        <result column="CUSTOMER_NAME" property="customerName"/>
        <result column="TYPE_NAME" property="deviceType"/>
        <result column="TYPE_DESCRIPTION" property="deviceDescription"/>
        <result column="MATERIAL_NUMBER" property="materialNumber"/>
        <result column="SERIAL_NUMBER" property="serialNumber"/>
        <result column="SETUP_END_DATETIME" property="setupEndDatetime"/>
        <result column="WARRANTY_EXPIRATION_DATETIME" property="warrantyExpirationDatetime"/>
        <result column="IP_ADDRESS" property="ipAddress"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="column_list">
        ID, SYSTEM_ID, MATERIAL_NUMBER, STATUS, CUSTOMER_ID, TYPE_ID, SHIPPING_DATETIME, SETUP_START_DATETIME,
        SETUP_END_DATETIME, ENGINEER_ID, SALESMAN, SERIAL_NUMBER, WARRANTY_EFFECTIVE_DATETIME,
        WARRANTY_EXPIRATION_DATETIME, ORDER_NUMBER, PROJECT_MANAGER, INSTALLATION_ENGINEER, ACCEPTANCE_CHECK_DATETIME,
        SECOND_ENGINEER_ID, DONGLE_ID, WEIXIN_RECEIVERS, SERVICE_KEY_L2, L2_KEY_EXPIRATION_DATETIME, SERVICE_KEY_L3,
        L3_KEY_EXPIRATION_DATETIME, SERVICE_KEY_L1, DELETED, CREATE_USER_ID, CREATE_DATETIME, MODIFY_USER_ID,
        MODIFY_DATETIME, VERSION, SF_ID, MANUFACTURER
    </sql>

    <select id="queryForPageList" resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceModel">
        SELECT
        d.ID,
        d.SYSTEM_ID AS 'System_ID',
        d.CUSTOMER_ID AS 'CUSTOMER_ID',<!--客户ID-->
        dt.`NAME` AS 'DEVICE_TYPE',<!--设备型号-->
        dt.DESCRIPTION AS 'DEVICE_DESCRIPTION',<!--系统型号-->
        d.MATERIAL_NUMBER AS 'MATERIAL_NUMBER',<!--物料号-->
        d.SERIAL_NUMBER AS 'SERIAL_NUMBER',<!--序列号-->
        d.SETUP_END_DATETIME AS 'SETUP_END_DATETIME',<!--安装结束日期-->
        d.WARRANTY_EXPIRATION_DATETIME AS 'WARRANTY_EXPIRATION_DATETIME',<!--保修失效日期-->
        di.IP_ADDRESS AS 'IP_ADDRESS',<!--IP地址-->
        ds.STORE_STATUS
        FROM
        device d
        LEFT JOIN manufacturer m ON m.Id = d.MANUFACTURER_ID
        LEFT JOIN device_type dt ON d.TYPE_ID = dt.ID
        LEFT JOIN device_info di ON d.id = di.DEVICE_ID
        LEFT JOIN device_store ds on d.ID = ds.DEVICE_ID and ds.DELETED=0 and ds.STORE_TYPE = 0 and ds.USER_ID = #{queryParam.userId}
        where d.DELETED=0 AND di.DELETED=0
        <if test="queryParam.systemId != null and queryParam.systemId!=''">
            AND d.SYSTEM_ID like CONCAT('%',#{queryParam.systemId,jdbcType=VARCHAR},'%')
        </if>
        <if test="queryParam.customerId != null ">
            AND d.CUSTOMER_ID =#{queryParam.customerId}
        </if>
        <if test="queryParam.serialNumber != null and queryParam.serialNumber !=''">
            AND d.SERIAL_NUMBER like CONCAT('%',#{queryParam.serialNumber,jdbcType=VARCHAR},'%')
        </if>
        <if test="queryParam.deviceTypeList!= null">
            AND d.TYPE_ID in
            <foreach item="item" index="index" collection="queryParam.deviceTypeList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="queryParam.orderNumber != null and queryParam.orderNumber != ''">
            AND d.ORDER_NUMBER like CONCAT('%',#{queryParam.orderNumber,jdbcType=VARCHAR},'%')
        </if>
        <if test="queryParam.materialNumber != null and queryParam.materialNumber !=''">
            AND d.MATERIAL_NUMBER like CONCAT('%',#{queryParam.materialNumber,jdbcType=VARCHAR},'%')
        </if>
        <if test="queryParam.manufacturerId != null and queryParam.manufacturerId !=''">
            AND d.MANUFACTURER_ID =#{queryParam.manufacturerId}
        </if>
        <if test="queryParam.customerList!= null">
            AND d.CUSTOMER_ID in
            <foreach item="item" index="index" collection="queryParam.customerList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="queryParam.storeStatus != null and queryParam.storeStatus == 1">
            and ds.STORE_STATUS = #{queryParam.storeStatus}
        </if>
    </select>
    <select id="queryForPageOtherList" resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceModelView">
        SELECT
        d.ID,
        d.SYSTEM_ID AS 'System_ID',
        dt.`NAME` AS 'DEVICE_TYPE',<!--设备型号-->
        d.SERIAL_NUMBER AS 'SERIAL_NUMBER',<!--序列号-->
        d.ENGINEER_ID,
        d.SETUP_START_DATETIME,
        d.SETUP_END_DATETIME AS 'SETUP_END_DATETIME',<!--安装结束日期-->
        d.WARRANTY_EFFECTIVE_DATETIME,
        d.WARRANTY_EXPIRATION_DATETIME AS 'WARRANTY_EXPIRATION_DATETIME', <!--保修失效日期-->
        ds.STORE_STATUS
        FROM
        device d
        LEFT JOIN device_type dt ON d.TYPE_ID = dt.ID
        LEFT JOIN device_store ds on d.ID = ds.DEVICE_ID and ds.DELETED=0 and ds.STORE_TYPE = 0 and ds.USER_ID = #{queryParam.userId}
        where d.DELETED=0
        AND d.CUSTOMER_ID = #{queryParam.customerId}
        <if test="queryParam.systemId != null and queryParam.systemId!=''">
            AND d.SYSTEM_ID like CONCAT('%',#{queryParam.systemId,jdbcType=VARCHAR},'%')
        </if>
        <if test="queryParam.deviceTypeList!= null">
            AND d.TYPE_ID in
            <foreach item="item" index="index" collection="queryParam.deviceTypeList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="queryParam.warrantyExpirationDateStart != null">
            and d.WARRANTY_EXPIRATION_DATETIME >= #{queryParam.warrantyExpirationDateStart}
        </if>
        <if test="queryParam.warrantyExpirationDateEnd != null">
            <![CDATA[and d.WARRANTY_EXPIRATION_DATETIME <= #{queryParam.warrantyExpirationDateEnd}]]>
        </if>
        <if test="queryParam.setupStartDateStart != null">
            AND d.SETUP_START_DATETIME>=#{queryParam.setupStartDateStart}
        </if>
        <if test="queryParam.setupStartDateEnd != null">
            <![CDATA[and d.SETUP_START_DATETIME <= #{queryParam.setupStartDateEnd}]]>
        </if>
        <if test="queryParam.manufacturerId != null and queryParam.manufacturerId !=''">
            AND d.MANUFACTURER_ID =#{queryParam.manufacturerId}
        </if>
        <if test="queryParam.storeStatus != null and queryParam.storeStatus == 1">
            and ds.STORE_STATUS = #{queryParam.storeStatus}
        </if>
    </select>

    <select id="queryRelateDevice" resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceModel">
        SELECT d.ID, d.CUSTOMER_ID, dt.NAME DEVICE_TYPE,d.SERIAL_NUMBER
        FROM
        device d
        LEFT JOIN device_type dt ON d.TYPE_ID = dt.ID
        WHERE d.DELETED=0
        AND d.CUSTOMER_ID = #{customerId}
    </select>
    <select id="queryRelateDeviceList" resultType="com.uih.uplus.solar.equipment.management.model.view.RelateDevice">
        SELECT
        d.ID,
        d.SYSTEM_ID,
        d.SERIAL_NUMBER,
        dt.`NAME` DEVICE_TYPE,
        di.IP_ADDRESS
        FROM
        device d
        LEFT JOIN device_info di ON d.id = di.DEVICE_ID
        LEFT JOIN device_type dt ON dt.ID = d.TYPE_ID
        WHERE
        d.ID IN (
        SELECT
        dv.device_id
        FROM
        device_vpn dv
        WHERE
        VPN_ID = #{vpnId}
        and DELETED=0
        )
        AND d.DELETED=0
    </select>

    <select id="queryTest" resultType="com.uih.uplus.solar.equipment.management.entity.Device">
        select * from device
    </select>


    <select id="queryDeviceMonitorList"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceMonitorModel">
        select DISTINCT a.ID device_id ,b.CONNECT_STATUS device_connect_status ,a.ENGINEER_ID ENGINEER_ID,
        b.CONNECT_UPDATE_DATETIME device_connect_update_datetime , d.CONNECT_STATUS vpn_connect_status ,a.SYSTEM_ID ,
        a.CUSTOMER_ID customer_id ,f.NAME device_type_name ,f.DESCRIPTION device_type_desc , b.IP_ADDRESS device_ip_address,
        b.LOG_UPLOAD_DATETIME,d.NAME vpn_name ,g.PURCHASE_DEPT department, h.NAME manufacturer_name,b.MODIFY_DATETIME,
        pt.NAME product_type_name,a.SERIAL_NUMBER,ds.STORE_STATUS
        from device a
        left join device_info b on a.ID = b.DEVICE_ID and b.DELETED = 0
        left join device_vpn c on a.ID = c.DEVICE_ID and c.DELETED = 0
        left join vpn d on c.VPN_ID = d.ID and d.DELETED = 0
        left join device_type f on a.TYPE_ID = f.ID and f.DELETED = 0
        left join product_type pt on f.PRODUCT_TYPE_ID = pt.ID and pt.DELETED = 0
        left join device_archives g on a.ID = g.DEVICE_ID and g.DELETED = 0
        left join manufacturer h on a.MANUFACTURER_ID = h.ID and h.DELETED = 0
        left join device_store ds on a.ID=ds.DEVICE_ID and ds.DELETED=0 and ds.STORE_TYPE = 1  and ds.USER_ID = #{deviceMonitorCondition.userId}
        where a.DELETED = 0
        and b.IP_ADDRESS != ''
        <if test="deviceMonitorCondition.deviceConnectStatus != null">
            <if test="deviceMonitorCondition.deviceConnectStatus == 1">
                and b.CONNECT_STATUS = #{deviceMonitorCondition.deviceConnectStatus}
            </if>
            <if test="deviceMonitorCondition.deviceConnectStatus != 1">
                and (b.CONNECT_STATUS = #{deviceMonitorCondition.deviceConnectStatus}
                or b.CONNECT_STATUS is null)
            </if>
        </if>
        <if test="deviceMonitorCondition.vpnConnectStatus != null">
            <if test="deviceMonitorCondition.vpnConnectStatus == 1">
                and d.CONNECT_STATUS = #{deviceMonitorCondition.vpnConnectStatus}
            </if>
            <if test="deviceMonitorCondition.vpnConnectStatus != 1">
                and (d.CONNECT_STATUS = #{deviceMonitorCondition.vpnConnectStatus}
                or d.CONNECT_STATUS is null)
            </if>
        </if>
        <if test="deviceMonitorCondition.systemId != null and deviceMonitorCondition.systemId != ''">
            and a.SYSTEM_ID like concat('%',#{deviceMonitorCondition.systemId},'%')
        </if>
        <if test="deviceMonitorCondition.serialNumber != null and deviceMonitorCondition.serialNumber != ''">
            and a.SERIAL_NUMBER like concat('%',#{deviceMonitorCondition.serialNumber},'%')
        </if>
        <if test="deviceMonitorCondition.customerId != null">
            and a.CUSTOMER_ID = #{deviceMonitorCondition.customerId}
        </if>
        <if test="deviceMonitorCondition.vpnName != null and deviceMonitorCondition.vpnName != ''">
            and d.NAME like concat('%',#{deviceMonitorCondition.vpnName},'%')
        </if>
        <if test="deviceMonitorCondition.deviceTypes != null">
            and a.TYPE_ID in
            <foreach item="item" index="index" collection="deviceMonitorCondition.deviceTypes" open="(" separator=","
                     close=")">
                #{item}
            </foreach>
        </if>
        <if test="deviceMonitorCondition.manufacturerId != null and deviceMonitorCondition.manufacturerId != ''">
            and a.MANUFACTURER_ID = #{deviceMonitorCondition.manufacturerId}
        </if>
        <if test="deviceMonitorCondition.storeStatus != null and deviceMonitorCondition.storeStatus==1">
            and ds.STORE_STATUS = #{deviceMonitorCondition.storeStatus}
        </if>
        <if test="deviceMonitorCondition.fastSearchText != null and deviceMonitorCondition.fastSearchText != ''">
            and (a.SERIAL_NUMBER like concat('%',#{deviceMonitorCondition.fastSearchText},'%')
            or  a.SYSTEM_ID like concat('%',#{deviceMonitorCondition.fastSearchText},'%')
            or  f.NAME like concat('%',#{deviceMonitorCondition.fastSearchText},'%'))
        </if>
    </select>

    <select id="queryDeviceMonitorOtherList"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceMonitorView">
        select DISTINCT
        a.ID device_id,
        b.CONNECT_STATUS device_connect_status,
        a.SYSTEM_ID,
        f. NAME device_type_name,
        b.IP_ADDRESS device_ip_address,
        g.PURCHASE_DEPT PURCHASE_DEPT,
        g.HOSPITAL_AREA,
        g.INSTALL_ADDRESS,
        h. NAME manufacturer_name,
        a.ENGINEER_ID ENGINEER_ID,
        b.MODIFY_DATETIME,
        pt.NAME product_type_name,
        a.SERIAL_NUMBER,
        ds.STORE_STATUS
        from device a
        left join device_info b on a.ID = b.DEVICE_ID and b.DELETED = 0
        left join device_type f on a.TYPE_ID = f.ID and f.DELETED = 0
        left join product_type pt on f.PRODUCT_TYPE_ID = pt.ID and pt.DELETED = 0
        left join device_archives g on a.ID = g.DEVICE_ID and g.DELETED = 0
        left join manufacturer h on a.MANUFACTURER_ID = h.ID and h.DELETED = 0
        left join device_store ds on a.ID=ds.DEVICE_ID and ds.DELETED=0 and ds.STORE_TYPE = 1 and ds.USER_ID = #{deviceMonitorCondition.userId}
        where a.DELETED = 0
        and b.IP_ADDRESS != ''
        and a.CUSTOMER_ID = #{deviceMonitorCondition.customerId}
        <if test="deviceMonitorCondition.deviceConnectStatus != null">
            <if test="deviceMonitorCondition.deviceConnectStatus == 1">
                and b.CONNECT_STATUS = #{deviceMonitorCondition.deviceConnectStatus}
            </if>
            <if test="deviceMonitorCondition.deviceConnectStatus != 1">
                and (b.CONNECT_STATUS = #{deviceMonitorCondition.deviceConnectStatus}
                or b.CONNECT_STATUS is null)
            </if>
        </if>
        <if test="deviceMonitorCondition.hospitalArea!=null and deviceMonitorCondition.hospitalArea != ''">
            and g.HOSPITAL_AREA like concat('%',#{deviceMonitorCondition.hospitalArea},'%')
        </if>
        <if test="deviceMonitorCondition.purchaseDept!=null and deviceMonitorCondition.purchaseDept != ''">
            and g.PURCHASE_DEPT like concat('%',#{deviceMonitorCondition.purchaseDept},'%')
        </if>

        <if test="deviceMonitorCondition.installAddress!=null and deviceMonitorCondition.installAddress != ''">
            and g.INSTALL_ADDRESS like concat('%',#{deviceMonitorCondition.installAddress},'%')
        </if>
        <if test="deviceMonitorCondition.deviceTypes != null">
            and a.TYPE_ID in
            <foreach item="item" index="index" collection="deviceMonitorCondition.deviceTypes" open="(" separator=","
                     close=")">
                #{item}
            </foreach>
        </if>
        <if test="deviceMonitorCondition.manufacturerId != null and deviceMonitorCondition.manufacturerId != ''">
            and a.MANUFACTURER_ID = #{deviceMonitorCondition.manufacturerId}
        </if>
        <if test="deviceMonitorCondition.storeStatus != null and deviceMonitorCondition.storeStatus==1">
            and ds.STORE_STATUS = #{deviceMonitorCondition.storeStatus}
        </if>
        <if test="deviceMonitorCondition.fastSearchText != null and deviceMonitorCondition.fastSearchText != ''">
            and (a.SERIAL_NUMBER like concat('%',#{deviceMonitorCondition.fastSearchText},'%')
            or  a.SYSTEM_ID like concat('%',#{deviceMonitorCondition.fastSearchText},'%')
            or  f.NAME like concat('%',#{deviceMonitorCondition.fastSearchText},'%'))
        </if>
    </select>


    <select id="queryDeviceListWithoutIp" parameterType="long"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceModel">
        SELECT d.ID, d.CUSTOMER_ID, dt.NAME DEVICE_TYPE,d.SERIAL_NUMBER
        FROM
        device d
        LEFT JOIN device_type dt ON d.TYPE_ID = dt.ID
        LEFT JOIN device_info di ON di.DEVICE_ID=d.ID
        WHERE
        d.DELETED=0 AND (di.IP_ADDRESS='' OR di.IP_ADDRESS IS NULL) AND d.CUSTOMER_ID = #{customerId}
    </select>
    <select id="getDeviceMonitorEditInfoById"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceMonitorEditModel">
        SELECT d.CUSTOMER_ID ,
        CONCAT('|', dt.`NAME`,'|',d.SERIAL_NUMBER) DEVICE_INFO_TEXT,
        v.ID VPN_ID,
        di.IP_ADDRESS IP_ADDRESS,
        di.IACU_IP_ADDRESS IACU_IP_ADDRESS,
        di.OPERATE_LIST OPERATE_LIST_STR,
        d.VERSION
        FROM
        device d
        LEFT JOIN device_type dt ON d.TYPE_ID = dt.ID
        LEFT JOIN device_info di ON di.DEVICE_ID = d.ID AND (di.DELETED=0 OR di.DELETED IS NULL)
        LEFT JOIN device_vpn dv ON dv.DEVICE_ID=d.ID AND (dv.DELETED=0 OR dv.DELETED IS NULL)
        LEFT JOIN vpn v ON v.ID=dv.VPN_ID
        WHERE d.DELETED=0
        <if test="deviceId != null">
            AND d.ID = #{deviceId}
        </if>
    </select>
    <select id="getById" resultType="com.uih.uplus.solar.equipment.management.model.modify.DeviceModify">
        SELECT
        d.ID,
        d.SYSTEM_ID AS 'System_ID',
        d.CUSTOMER_ID,<!--客户ID-->
        dt.`ID` AS 'TYPE_ID',<!--设备型号-->
        <!--        dt.DESCRIPTION AS 'DEVICE_DESCRIPTION',--><!--系统型号-->
        d.ORDER_NUMBER AS 'ORDER_NUMBER',<!--订单号-->
        d.MATERIAL_NUMBER AS 'MATERIAL_NUMBER',<!--物料号-->
        d.SERIAL_NUMBER AS 'SERIAL_NUMBER',<!--序列号-->
        d.SHIPPING_DATETIME AS 'SHIPPING_DATETIME',<!--发运日期-->
        d.SETUP_START_DATETIME As 'SETUP_START_DATETIME',<!--开始安装日期-->
        d.SETUP_END_DATETIME AS 'SETUP_END_DATETIME',<!--安装结束日期-->
        d.WARRANTY_EFFECTIVE_DATETIME AS 'WARRANTY_EFFECTIVE_DATETIME',<!--保修生效日期 -->
        d.WARRANTY_EXPIRATION_DATETIME AS 'WARRANTY_EXPIRATION_DATETIME',<!--保修失效日期-->
        d.ENGINEER_ID AS 'ENGINEER_ID',<!--第一责任工程师-->
        d.INSTALLATION_ENGINEER AS 'INSTALLATION_ENGINEER',<!--安装工程师-->
        d.SALESMAN AS 'SALESMAN',<!--销售人员-->
        d.DONGLE_ID AS 'DONGLE_ID',<!--加密狗ID-->
        d.SECOND_ENGINEER_ID AS 'SECOND_ENGINEER_ID',<!--第二责任工程师-->
        d.PROJECT_MANAGER As 'PROJECT_MANAGER',<!--项目经理-->
        di.IP_ADDRESS AS 'IP_ADDRESS',<!--IP地址-->
        d.VERSION
        FROM
        device d
        LEFT JOIN manufacturer m ON m.Id = d.MANUFACTURER_ID
        LEFT JOIN device_type dt ON d.TYPE_ID = dt.ID
        LEFT JOIN device_info di ON d.id = di.DEVICE_ID
        where d.DELETED=0
        AND d.ID = #{id}
    </select>
    <select id="queryDeviceBrandDistribute"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceBrandDistributeModel">
        SELECT
        pt.`NAME`AS 'PRODUCT_TYPE_NAME',
        m.`NAME` AS 'DEVICE_BRAND',
        count(1) AS 'AMOUNT'
        FROM
        device d
        LEFT JOIN manufacturer m ON m.ID = d.MANUFACTURER_ID
        LEFT JOIN device_type dt ON dt.ID = d.TYPE_ID
        LEFT JOIN product_type pt ON pt.ID = dt.PRODUCT_TYPE_ID
        LEFT JOIN device_info di ON di.DEVICE_ID = d.ID
        WHERE
        d.DELETED = 0
        AND di.IP_ADDRESS IS NOT NULL
        AND di.IP_ADDRESS != ''
        and pt.`NAME` in
        <foreach item="item" index="index" collection="productTypeList" open="(" separator=","
                 close=")">
            #{item}
        </foreach>
        <if test="customerId!=null">
            AND d.CUSTOMER_ID = #{customerId}
        </if>
        GROUP BY
        pt.`NAME`,
        m.`NAME`
    </select>
    <select id="queryDeviceBrandDistributeForEngineer"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceBrandDistributeForEngineerModel">
        SELECT
            pt.`NAME`AS 'PRODUCT_TYPE_NAME',
            dt.`NAME` AS 'DEVICE_TYPE',
            count(1) AS 'AMOUNT'
        FROM
        device d
            LEFT JOIN manufacturer m ON m.ID = d.MANUFACTURER_ID
            LEFT JOIN device_type dt ON dt.ID = d.TYPE_ID
            LEFT JOIN product_type pt ON pt.ID = dt.PRODUCT_TYPE_ID
            LEFT JOIN device_info di ON di.DEVICE_ID = d.ID
        WHERE
        d.DELETED = 0
        AND di.IP_ADDRESS IS NOT NULL
        AND di.IP_ADDRESS != ''
        and pt.`NAME` in
        <foreach item="item" index="index" collection="productTypeList" open="(" separator=","
                 close=")">
            #{item}
        </foreach>
        <if test="customerId!=null">
            AND d.CUSTOMER_ID = #{customerId}
        </if>
        GROUP BY
        pt.`NAME`,
        dt.`NAME`
    </select>
    <select id="queryDeviceTypeDistribute"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceTypeDistributeModel">
        SELECT
        pt.`NAME` AS 'PRODUCT_TYPE_NAME',
        count(dt1.ID) AS 'AMOUNT',
        count(dt1.ID) /
        case when (
        SELECT
            count(1)
            FROM
            device a
            LEFT JOIN device_type b ON b.ID = a.TYPE_ID
            LEFT JOIN product_type c ON c.ID = b.PRODUCT_TYPE_ID
            LEFT JOIN device_info di ON di.DEVICE_ID = a.ID
            WHERE
            a.DELETED = 0 AND di.DELETED = 0
            AND di.IP_ADDRESS IS NOT NULL
            AND di.IP_ADDRESS != ''
            <if test="customerIds!=null and customerIds.size()>0">
                AND a.CUSTOMER_ID in
                <foreach item="item" index="index" collection="customerIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            ) = 0 then 0.001
        else (
            SELECT
            count(1)
            FROM
            device a
            LEFT JOIN device_type b ON b.ID = a.TYPE_ID
            LEFT JOIN product_type c ON c.ID = b.PRODUCT_TYPE_ID
            LEFT JOIN device_info di ON di.DEVICE_ID = a.ID
            WHERE
            a.DELETED = 0 AND di.DELETED = 0
            AND di.IP_ADDRESS IS NOT NULL
            AND di.IP_ADDRESS != ''
            <if test="customerIds!=null and customerIds.size()>0">
                AND a.CUSTOMER_ID in
                <foreach item="item" index="index" collection="customerIds" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            ) end AS 'PERCENTAGE'
        FROM
        product_type pt
        LEFT JOIN (
        SELECT
        dt.`Name`,
        dt.ID,
        dt.PRODUCT_TYPE_ID,
        di.IP_ADDRESS
        FROM
        device d
        JOIN device_type dt ON dt.ID = d.TYPE_ID
        JOIN device_info di ON di.DEVICE_ID = d.ID
        WHERE
        d.DELETED = 0 AND di.DELETED = 0
        AND di.IP_ADDRESS IS NOT NULL
        AND di.IP_ADDRESS != ''
        <if test="customerIds!=null and customerIds.size()>0">
            AND d.CUSTOMER_ID in
            <foreach item="item" index="index" collection="customerIds" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) dt1 ON dt1.PRODUCT_TYPE_ID = pt.ID
        WHERE
        pt.`NAME` IN
        <foreach item="item" index="index" collection="productTypeList" open="(" separator=","
                 close=")">
            #{item}
        </foreach>
        GROUP BY
        pt.`NAME`
    </select>
    <select id="getServiceKeyInfo" resultType="com.uih.uplus.solar.equipment.management.model.view.ServiceKeyModel">
        SELECT
        d.CUSTOMER_ID,
        dt.DESCRIPTION AS SYSTEM_TYPE,
        d.SERIAL_NUMBER,
        d.SYSTEM_ID,
        d.SERVICE_KEY_L1,
        d.SERVICE_KEY_L2,
        d.L2_KEY_EXPIRATION_DATETIME
        FROM device d
        LEFT JOIN device_type dt ON d.TYPE_ID=dt.ID
        WHERE d.DELETED=0
        <if test="deviceId != null">
            AND d.ID = #{deviceId}
        </if>
    </select>
    <select id="getDeviceInfoForSectionView" parameterType="long"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceInfoForSectionView">
        SELECT
        d.ID AS ID,
        d.SYSTEM_ID AS SYSTEM_ID,
        d.DEVICE_TYPE_ID AS DEVICE_TYPE_ID,
        d.ENGINEER_ID AS ENGINEER_ID,
        d.`SERIAL_NUMBER` AS SERIAL_NUMBER,
        d.`DEVICE_TYPE_NAME` AS DEVICE_TYPE_NAME,
        d.DEVICE_DESCRIPTION AS DEVICE_DESCRIPTION,
        d.PRODUCT_TYPE_ID AS PRODUCT_TYPE_ID,
        d.`PRODUCT_TYPE_NAME` AS PRODUCT_TYPE_NAME,
        d.SETUP_START_DATETIME,
        d.SETUP_END_DATETIME,
        d.WARRANTY_EFFECTIVE_DATETIME,
        d.WARRANTY_EXPIRATION_DATETIME,
        device_archives.PURCHASE_DEPT AS PURCHASE_DEPT,
        d.MANUFACTURER_NAME AS MANUFACTURER_NAME
        FROM
        (
        SELECT
        device.ID AS ID,
        device.SYSTEM_ID AS SYSTEM_ID,
        device.TYPE_ID AS DEVICE_TYPE_ID,
        device.ENGINEER_ID AS ENGINEER_ID,
        device.`SERIAL_NUMBER` AS SERIAL_NUMBER,
        device.SETUP_START_DATETIME,
        device.SETUP_END_DATETIME,
        device.WARRANTY_EFFECTIVE_DATETIME,
        device.WARRANTY_EXPIRATION_DATETIME,
        device_type.`NAME` AS DEVICE_TYPE_NAME,
        device_type.DESCRIPTION AS DEVICE_DESCRIPTION,
        product_type.ID AS PRODUCT_TYPE_ID,
        product_type.`NAME` AS PRODUCT_TYPE_NAME,
        manufacturer.`NAME` AS MANUFACTURER_NAME
        FROM
        device
        LEFT JOIN device_type ON device.TYPE_ID = device_type.ID
        LEFT JOIN product_type ON device_type.PRODUCT_TYPE_ID = product_type.ID
        LEFT JOIN manufacturer ON device.MANUFACTURER_ID = manufacturer.ID
        WHERE
        device.ID = #{deviceId} AND device.DELETED=0
        ) AS d
        LEFT JOIN device_archives ON device_archives.DEVICE_ID = d.ID
    </select>
    <select id="queryDeviceList"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceMRLogModel">
        SELECT
        d.SYSTEM_ID AS 'SYSTEM_ID',
        d.SERIAL_NUMBER AS 'SERIAL_NUMBER',
        d.CUSTOMER_ID
        FROM
        device d
        LEFT JOIN device_type dt ON d.TYPE_ID = dt.ID
        LEFT JOIN product_type pt ON pt.ID = dt.PRODUCT_TYPE_ID
        LEFT JOIN device_info di ON di.DEVICE_ID = d.ID
        WHERE
        d.DELETED = 0
        AND di.IP_ADDRESS IS NOT NULL
        AND di.IP_ADDRESS != ''
        <if test="productName!=null and productName!=''">
            AND pt.`NAME` = #{productName}
        </if>
        <if test="customerId!=null and customerId!=0">
            AND d.CUSTOMER_ID = #{customerId}
        </if>
    </select>
    <select id="getDeviceInfoForSendMessage"
            resultType="com.uih.uplus.solar.equipment.management.model.view.DeviceInfoForSendMessage">
        SELECT
        device.ID AS DEVICE_ID,
        device.ENGINEER_ID AS FIRST_ENGINEERID,
        device.CUSTOMER_ID,
        device_type.ID AS DEVICE_TYPE_ID,
        device_type.DESCRIPTION AS SYSTEM_TYPE,
        device_type.`NAME` AS DEVICE_TYPE_NAME
        FROM
        device,
        device_type
        WHERE device.SYSTEM_ID=#{systemId} AND device.TYPE_ID=device_type.ID
        AND device.DELETED = 0 AND device_type.DELETED = 0
        LIMIT 1
    </select>
    <update id="updateServiceKeyInfo" parameterType="com.uih.uplus.solar.equipment.management.entity.Device">
        UPDATE device
        <set>
            <if test="serviceKeyL1 != null" >
                SERVICE_KEY_L1 = #{serviceKeyL1},
            </if>
            <if test="serviceKeyL2 != null" >
                SERVICE_KEY_L2 = #{serviceKeyL2},
            </if>
            <if test="serviceKeyL3 != null" >
                SERVICE_KEY_L3 = #{serviceKeyL3},
            </if>
            <if test="l2KeyExpirationDatetime != null" >
                L2_KEY_EXPIRATION_DATETIME = #{l2KeyExpirationDatetime},
            </if>
            <if test="l3KeyExpirationDatetime != null" >
                L3_KEY_EXPIRATION_DATETIME = #{l3KeyExpirationDatetime}
            </if>
        </set>
        WHERE device.DELETED=0
        <if test="id != null" >
            AND device.ID = #{id}
        </if>
    </update>
</mapper>
